<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unit Profit Simulator v10.5 Fixed</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }
        /* –í–æ—Ä–æ–Ω–∫–∞ */
        .funnel-step-shape {
            clip-path: polygon(0 0, 100% 0, 92% 100%, 8% 100%);
            transition: all 0.5s ease-out;
        }
        .funnel-step-last {
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
            border-radius: 0 0 16px 16px;
        }
        .card-shadow {
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
        }
        .arrow-bounce {
            animation: bounce-down 2s infinite;
        }
        @keyframes bounce-down {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(3px); }
        }
        .term-link {
            border-bottom: 1px dashed rgba(255,255,255,0.6);
            cursor: help;
            transition: all 0.2s;
        }
        .term-link:hover {
            opacity: 1;
            border-bottom-style: solid;
        }
        .term-link-dark {
            border-bottom: 1px dashed rgba(79, 70, 229, 0.4);
            cursor: help;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useId } = React;

        // --- CONSTANTS ---
        const DEFINITIONS = {
            CPL: { 
                title: "CPL (–¶–µ–Ω–∞ –∑–∞—è–≤–∫–∏)", 
                text: "üéì –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ:\nCost Per Lead ‚Äî —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏ –≤ —Ä–µ–∫–ª–∞–º–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.\n\nüó£ –ü–æ-–ø—Ä–æ—Å—Ç–æ–º—É:\n–¶–∏—Ñ—Ä–∞, –∫–æ—Ç–æ—Ä—É—é –≤—ã –≤–∏–¥–∏—Ç–µ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –Ø–Ω–¥–µ–∫—Å–∞/–í–ö. –≠—Ç–æ ¬´–≥–æ–ª–∞—è¬ª —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞, –±–µ–∑ —É—á–µ—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç —Ç–µ—Ö, –∫—Ç–æ —ç—Ç—É —Ä–µ–∫–ª–∞–º—É –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–ª." 
            },
            RealCPL: { 
                title: "–†–µ–∞–ª—å–Ω—ã–π CPL", 
                text: "üéì –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ:\nFully Loaded CPL = (–†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç + –§–û–¢ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞) / –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏–¥–æ–≤.\n\nüó£ –ü–æ-–ø—Ä–æ—Å—Ç–æ–º—É:\n–ß–µ—Å—Ç–Ω–∞—è —Ü–µ–Ω–∞ –∑–≤–æ–Ω–∫–∞ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–∞—Ä–º–∞–Ω–∞. –ï—Å–ª–∏ –≤—ã –ø–ª–∞—Ç–∏—Ç–µ —Å–ø–µ—Ü—É 50–∫, –∞ –∑–∞—è–≤–æ–∫ –º–∞–ª–æ ‚Äî —ç—Ç–æ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –≤ —Ä–∞–∑—ã –≤—ã—à–µ –æ–±—ã—á–Ω–æ–≥–æ CPL. –≠—Ç–æ —Ç–æ, —Å–∫–æ–ª—å–∫–æ –≤—ã —Ä–µ–∞–ª—å–Ω–æ –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º." 
            },
            DRR: { 
                title: "–î–†–† (–î–æ–ª—è –†–µ–∫–ª–∞–º—ã)", 
                text: "üéì –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ:\n–î–æ–ª—è –†–µ–∫–ª–∞–º–Ω—ã—Ö –†–∞—Å—Ö–æ–¥–æ–≤ = (–ë—é–¥–∂–µ—Ç –Ω–∞ —Ä–µ–∫–ª–∞–º—É / –í—ã—Ä—É—á–∫–∞) √ó 100%.\n\nüó£ –ü–æ-–ø—Ä–æ—Å—Ç–æ–º—É:\n–ö–∞–∫–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥ –≤—ã —Ç—É—Ç –∂–µ –æ—Ç–¥–∞–ª–∏ —Ä–µ–∫–ª–∞–º–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–µ." 
            },
            TotalDRR: { 
                title: "–î–†–† (–ò—Ç–æ–≥–æ–≤—ã–π)", 
                text: "üéì –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ:\nTotal Marketing Ratio = (–ë—é–¥–∂–µ—Ç + –ó–∞—Ä–ø–ª–∞—Ç—ã –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞) / –í—ã—Ä—É—á–∫–∞.\n\nüó£ –ü–æ-–ø—Ä–æ—Å—Ç–æ–º—É:\n–°–∞–º–∞—è –≤–∞–∂–Ω–∞—è —Ü–∏—Ñ—Ä–∞. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫—É—é —á–∞—Å—Ç—å –≤—ã—Ä—É—á–∫–∏ —Å—ä–µ–¥–∞–µ—Ç –≤–µ—Å—å –≤–∞—à –æ—Ç–¥–µ–ª –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞. –ï—Å–ª–∏ —ç—Ç–æ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Ä–∞—Å—Ç–µ—Ç, –∞ –ø—Ä–∏–±—ã–ª—å –ø–∞–¥–∞–µ—Ç ‚Äî –≤—ã –∫–æ—Ä–º–∏—Ç–µ –¥–∞—Ä–º–æ–µ–¥–æ–≤." 
            },
            MTP: { 
                title: "–î–æ–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –≤ –ø—Ä–∏–±—ã–ª–∏", 
                text: "üéì –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ:\nMarketing To Profit Ratio. –û—Ç–Ω–æ—à–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –∑–∞—Ç—Ä–∞—Ç –∫ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏ –¥–æ –≤—ã—á–µ—Ç–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞.\n\nüó£ –ü–æ-–ø—Ä–æ—Å—Ç–æ–º—É:\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –ø–∏—Ä–æ–≥ –≤–∞—à–µ–π –ø—Ä–∏–±—ã–ª–∏. –≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–æ–π –∫—É—Å–æ–∫ –≤—ã –æ—Ç—Ä–µ–∑–∞–µ—Ç–µ –∏ –æ—Ç–¥–∞–µ—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ —Ä–µ–∫–ª–∞–º—â–∏–∫–∞–º, —á—Ç–æ–±—ã —ç—Ç–æ—Ç –ø–∏—Ä–æ–≥ –≤–æ–æ–±—â–µ –∏—Å–ø–µ–∫—Å—è. –ï—Å–ª–∏ >50% ‚Äî –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤." 
            },
            PBM: { 
                title: "–ü—Ä–∏–±—ã–ª—å –î–û –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞", 
                text: "üéì –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ:\n–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –¥–æ –≤—ã—á–µ—Ç–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ.\n\nüó£ –ü–æ-–ø—Ä–æ—Å—Ç–æ–º—É:\n–î–µ–Ω—å–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–∏–∑–Ω–µ—Å –∑–∞—Ä–∞–±–æ—Ç–∞–ª ¬´—Å–∞–º –ø–æ —Å–µ–±–µ¬ª (–ø—Ä–æ–¥–∞–ª–∏ –º–∏–Ω—É—Å –∫—É–ø–∏–ª–∏, –º–∏–Ω—É—Å –∞—Ä–µ–Ω–¥–∞), –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã –ø–æ—Ç–æ–º –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç–µ –±–∞–Ω–∫–µ—Ç –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º ¬´–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥¬ª." 
            },
            CAC: { 
                title: "CAC (–°—Ç–æ–∏–º–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞)", 
                text: "üéì –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ:\nCustomer Acquisition Cost. –°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç—è—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.\n\nüó£ –ü–æ-–ø—Ä–æ—Å—Ç–æ–º—É:\n–°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏, —á—Ç–æ–±—ã –æ–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –∫—É–ø–∏–ª. –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã —ç—Ç–∞ —Ü–∏—Ñ—Ä–∞ –±—ã–ª–∞ –º–µ–Ω—å—à–µ, —á–µ–º –ø—Ä–∏–±—ã–ª—å —Å –∫–ª–∏–µ–Ω—Ç–∞ (LTV)." 
            }
        };

        const BENCHMARKS = {
            services: { name: '–£—Å–ª—É–≥–∏ / B2B', cpc: 50, crClick: 2.5, cpl: 2000, cr1: 30, cr2: 15, cr3: 25 },
            ecommerce: { name: '–¢–æ–≤–∞—Ä–∫–∞ / E-com', cpc: 15, crClick: 5, cpl: 300, cr1: 50, cr2: 60, cr3: 80 },
            infobiz: { name: '–ò–Ω—Ñ–æ–±–∏–∑ / –ö—É—Ä—Å—ã', cpc: 30, crClick: 7.5, cpl: 400, cr1: 40, cr2: 15, cr3: 10 }
        };

        // --- ICONS ---
        const Icon = ({ path, className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const Icons = {
            Calculator: (p) => <Icon {...p} path={<><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />,
            Info: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>} />,
            Banknote: (p) => <Icon {...p} path={<><rect width="20" height="12" x="2" y="6" rx="2" /><circle cx="12" cy="12" r="2" /><path d="M6 12h.01M18 12h.01" /></>} />, 
            Send: (p) => <Icon {...p} path={<><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />,
            Plus: (p) => <Icon {...p} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Briefcase: (p) => <Icon {...p} path={<><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>} />,
            ShoppingBag: (p) => <Icon {...p} path={<><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></>} />,
            GraduationCap: (p) => <Icon {...p} path={<><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></>} />,
            Sliders: (p) => <Icon {...p} path={<><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="2" x2="6" y1="14" y2="14"/><line x1="10" x2="14" y1="8" y2="8"/><line x1="18" x2="22" y1="16" y2="16"/></>} />,
            CheckCircle2: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />,
            XCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />,
            RefreshCw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />,
            TrendingUp: (p) => <Icon {...p} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />,
            AlertTriangle: (p) => <Icon {...p} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />,
            Target: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>} />,
            ChevronDown: (p) => <Icon {...p} path={<path d="m6 9 6 6 6-6"/>} />,
            ChevronUp: (p) => <Icon {...p} path={<path d="m18 15-6-6-6 6"/>} />,
            ChevronLeft: (p) => <Icon {...p} path={<path d="m15 18-6-6 6-6"/>} />,
            ChevronRight: (p) => <Icon {...p} path={<path d="m9 18 6-6-6-6"/>} />,
            HelpCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></>} />,
            PieChart: (p) => <Icon {...p} path={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>} />,
            Filter: (p) => <Icon {...p} path={<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>} />,
            Zap: (p) => <Icon {...p} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />,
            ArrowUpRight: (p) => <Icon {...p} path={<><path d="M7 7h10v10"/><path d="M7 17 17 7"/></>} />,
            ArrowDownRight: (p) => <Icon {...p} path={<><path d="m7 7 10 10"/><path d="M17 7v10H7"/></>} />,
            ArrowDown: (p) => <Icon {...p} path={<path d="M12 5v14M19 12l-7 7-7-7"/>} />,
            Pointer: (p) => <Icon {...p} path={<path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>} />,
            User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            CheckSquare: (p) => <Icon {...p} path={<><path d="m9 11 3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>} />
        };

        // --- GLOBAL HELPERS ---
        const formatMoney = (val) => new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 0 }).format(val).replace(/\u00A0/g, ' ') + ' ‚ÇΩ';
        const formatNum = (val) => new Intl.NumberFormat('ru-RU').format(val).replace(/\u00A0/g, ' ');
        const formatCompactNumber = (number) => {
            if (!number) return '';
            if (number >= 1000000) return (number / 1000000).toFixed(1).replace('.', ',') + ' –º–ª–Ω';
            if (number >= 1000) return (number / 1000).toFixed(0) + ' —Ç—ã—Å';
            return number;
        };

        // --- SUB-COMPONENTS ---
        const FormattedInput = ({ label, value, onChange, suffix, tip, disabled }) => {
            const inputId = useId();
            const [displayValue, setDisplayValue] = useState(formatNum(value).replace(' ‚ÇΩ', ''));

            useEffect(() => {
                if (document.activeElement?.id !== inputId) {
                     setDisplayValue(formatNum(value).replace(' ‚ÇΩ', ''));
                }
            }, [value, inputId]);

            const handleChange = (e) => {
                const rawValue = e.target.value.replace(/[^0-9]/g, ''); 
                const numValue = Number(rawValue);
                setDisplayValue(formatNum(numValue).replace(' ‚ÇΩ', '')); 
                onChange(numValue);
            };

            return (
                <div className="mb-4">
                    {label && <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">{label}</label>}
                    <div className="relative group">
                        <input 
                            id={inputId}
                            type="text" 
                            inputMode="numeric" 
                            value={displayValue} 
                            onChange={handleChange} 
                            disabled={disabled}
                            className={`w-full border rounded-xl px-3 py-3 font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm text-lg ${disabled ? 'bg-slate-100 text-slate-400 border-slate-200' : 'bg-slate-50 text-slate-900 border-slate-200 focus:bg-white'}`} 
                        />
                        {suffix && <span className="absolute right-3 top-3.5 text-slate-400 font-medium pointer-events-none">{suffix}</span>}
                    </div>
                    <div className="flex justify-between mt-1 min-h-[20px]">
                        {tip && <div className="text-[10px] text-slate-400 leading-tight flex-1 mr-2">{tip}</div>}
                        {value >= 1000 && <div className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded h-fit whitespace-nowrap ml-auto">{formatCompactNumber(value)}</div>}
                    </div>
                </div>
            );
        };
        
        // --- RESTORED TableInput COMPONENT ---
        const TableInput = ({ value, onChange, placeholder, align = 'left' }) => {
            const [displayValue, setDisplayValue] = useState(formatNum(value));
            useEffect(() => {
                const numericDisplay = Number(displayValue.replace(/\s/g, ''));
                if (numericDisplay !== value) {
                        setDisplayValue(formatNum(value));
                }
            }, [value]);
            const handleChange = (e) => {
                const rawValue = e.target.value.replace(/[^0-9]/g, ''); 
                const numValue = Number(rawValue);
                setDisplayValue(formatNum(numValue)); 
                onChange(numValue);
            };
            return (
                <input type="text" inputMode="numeric" value={displayValue} placeholder={placeholder} onChange={handleChange} 
                    className={`w-full bg-white border border-slate-200 rounded-lg px-2 py-1 text-sm font-mono focus:ring-1 focus:ring-indigo-500 outline-none text-${align}`} />
            );
        };

        const DefinitionModal = ({ term, onClose }) => {
            const data = DEFINITIONS[term];
            if (!data) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icons.XCircle size={24} /></button>
                        <div className="flex items-center gap-2 mb-3 text-indigo-600"><Icons.Info size={24} /><h3 className="font-bold text-lg">{data.title}</h3></div>
                        <div className="text-slate-600 text-sm leading-relaxed whitespace-pre-line">{data.text}</div>
                        <button onClick={onClose} className="w-full mt-6 bg-indigo-50 text-indigo-700 py-3 rounded-xl font-bold">–í—Å—ë –ø–æ–Ω—è—Ç–Ω–æ</button>
                    </div>
                </div>
            );
        };

        const ExpertInsight = ({ stats, isProfitable, onShowDefinition }) => {
            const drr = stats.drrTotalRevenue;
            const share = stats.marketingShareOfProfit;
            
            if (!isProfitable) {
                return (
                    <div className="bg-red-500/20 border border-red-500/30 rounded-xl p-4 mt-4">
                        <div className="flex items-start gap-2 mb-2">
                            <Icons.AlertTriangle className="text-red-100 shrink-0 mt-0.5" size={20} />
                            <span className="font-bold text-red-100 text-sm">–í—ã —Å–ø–æ–Ω—Å–∏—Ä—É–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤</span>
                        </div>
                        <p className="text-xs text-white/80 leading-relaxed mb-2">
                            –ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –∫–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω–æ—Å–∏—Ç –≤–∞–º —É–±—ã—Ç–æ–∫. –í—ã –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –±–æ–ª—å—à–µ, —á–µ–º –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –Ω–∞ –Ω–µ–º.
                            –í–∞—à <span className="term-link text-white font-bold cursor-pointer" onClick={() => onShowDefinition('RealCPL')}>–†–µ–∞–ª—å–Ω—ã–π CPL</span> —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç <strong>{formatMoney(Math.round(stats.realCPL))}</strong>.
                            <br/><br/>
                            <strong>–í–µ—Ä–¥–∏–∫—Ç:</strong> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–µ–∫–ª–∞–º—É. –ù—É–∂–Ω–æ –ª–∏–±–æ –ø–æ–¥–Ω–∏–º–∞—Ç—å —á–µ–∫, –ª–∏–±–æ —á–∏–Ω–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é –≤ –ø—Ä–æ–¥–∞–∂—É.
                        </p>
                    </div>
                );
            }

            if (drr > 30) {
                return (
                     <div className="bg-orange-500/20 border border-orange-500/30 rounded-xl p-4 mt-4">
                        <div className="flex items-start gap-2 mb-2">
                            <Icons.AlertTriangle className="text-orange-100 shrink-0 mt-0.5" size={20} />
                            <span className="font-bold text-orange-100 text-sm">–í—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –Ω–∞ —Ä–µ–∫–ª–∞–º–Ω—É—é —Å–∏—Å—Ç–µ–º—É</span>
                        </div>
                        <p className="text-xs text-white/80 leading-relaxed">
                            –í—ã –≤ –ø–ª—é—Å–µ, –Ω–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ —Å—ä–µ–¥–∞–µ—Ç –±–æ–ª—å—à–µ —Ç—Ä–µ—Ç–∏ –≤—ã—Ä—É—á–∫–∏. –≠—Ç–æ –∑–æ–Ω–∞ –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∏—Å–∫–∞. –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ–¥–æ—Ä–æ–∂–∞–µ—Ç –Ω–∞ 20%, –≤—ã –º–æ–∂–µ—Ç–µ —É–π—Ç–∏ –≤ –Ω–æ–ª—å.
                            <br/><br/>
                            <strong>–°–æ–≤–µ—Ç:</strong> –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂–∞—Ö (LTV), —á—Ç–æ–±—ã –æ–∫—É–ø–∞—Ç—å —ç—Ç–æ—Ç –¥–æ—Ä–æ–≥–æ–π —Ç—Ä–∞—Ñ–∏–∫.
                        </p>
                    </div>
                );
            }

            if (drr > 15) {
                return (
                     <div className="bg-yellow-500/20 border border-yellow-500/30 rounded-xl p-4 mt-4">
                        <div className="flex items-start gap-2 mb-2">
                            <Icons.Info className="text-yellow-100 shrink-0 mt-0.5" size={20} />
                            <span className="font-bold text-yellow-100 text-sm">–†–∞–±–æ—á–∞—è –º–æ–¥–µ–ª—å</span>
                        </div>
                        <p className="text-xs text-white/80 leading-relaxed">
                            –ë–∏–∑–Ω–µ—Å –ø—Ä–∏–Ω–æ—Å–∏—Ç –¥–µ–Ω—å–≥–∏. –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É –æ—â—É—Ç–∏–º—ã, –Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã –¥–ª—è —Ä–æ—Å—Ç–∞.
                            <br/><br/>
                            <strong>–°–æ–≤–µ—Ç:</strong> –°–ª–µ–¥–∏—Ç–µ –∑–∞ <span className="term-link text-white cursor-pointer" onClick={() => onShowDefinition('TotalDRR')}>–∏—Ç–æ–≥–æ–≤—ã–º –î–†–†</span>.
                        </p>
                    </div>
                );
            }

            return (
                <div className="bg-emerald-500/20 border border-emerald-500/30 rounded-xl p-4 mt-4">
                    <div className="flex items-start gap-2 mb-2">
                        <Icons.CheckCircle2 className="text-emerald-100 shrink-0 mt-0.5" size={20} />
                        <span className="font-bold text-emerald-100 text-sm">–ü–µ—á–∞—Ç–Ω—ã–π —Å—Ç–∞–Ω–æ–∫</span>
                    </div>
                    <p className="text-xs text-white/80 leading-relaxed">
                        –í–∞—à –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—É–ø–µ—Ä-—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ. –í—ã –æ—Ç–¥–∞–µ—Ç–µ –≤—Å–µ–≥–æ {share.toFixed(0)}% –æ—Ç –ø—Ä–∏–±—ã–ª–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —ç—Ç–∏ –¥–µ–Ω—å–≥–∏.
                        <br/><br/>
                        <strong>–°–æ–≤–µ—Ç:</strong> –°–º–µ–ª–æ –∑–∞–ª–∏–≤–∞–π—Ç–µ –±—é–¥–∂–µ—Ç! –£ –≤–∞—Å –æ–≥—Ä–æ–º–Ω—ã–π –∑–∞–ø–∞—Å –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ –¥–ª—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞ —Ä—ã–Ω–∫–∞.
                    </p>
                </div>
            );
        };

        const ScalingSimulator = ({ stats, scaleBudget, setScaleBudget, scaleStats }) => {
            const maxBudget = Math.max((stats.adBudget * 3), 1000000); 
            
            return (
                <div className="bg-gradient-to-br from-indigo-50 to-white p-5 rounded-2xl border border-indigo-100 shadow-sm mb-6">
                    <div className="flex items-center gap-2 mb-4 text-indigo-800"><Icons.Zap size={20} /><h3 className="font-bold text-base">–°–∏–º—É–ª—è—Ç–æ—Ä –º–∞—Å—à—Ç–∞–±–∞</h3></div>
                    
                    <div className="mb-6">
                        <div className="flex justify-between items-end mb-2">
                            <span className="text-xs font-bold text-slate-500 uppercase">–ï—Å–ª–∏ –≤–ª–æ–∂–∏—Ç—å –≤ —Ä–µ–∫–ª–∞–º—É:</span>
                            <span className="text-xl font-bold text-indigo-700 bg-indigo-50 px-2 py-1 rounded">{formatMoney(scaleBudget)}</span>
                        </div>
                        <input type="range" min="0" max={maxBudget} step={5000} value={scaleBudget} onChange={(e) => setScaleBudget(Number(e.target.value))} className="w-full h-3 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-3 rounded-xl border border-indigo-50 shadow-sm">
                            <div className="text-[10px] text-slate-400 uppercase font-bold mb-1">–í—ã—Ä—É—á–∫–∞</div>
                            <div className="text-lg font-bold text-slate-800">{formatMoney(scaleStats.revenue)}</div>
                        </div>
                        <div className="bg-white p-3 rounded-xl border border-indigo-50 shadow-sm">
                            <div className="text-[10px] text-slate-400 uppercase font-bold mb-1">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                            <div className={`text-lg font-bold ${scaleStats.profit > 0 ? 'text-emerald-600' : 'text-red-500'}`}>{formatMoney(scaleStats.profit)}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const FunnelDetailModal = ({ step, onClose }) => {
            if (!step) return null;
            const StepIcon = step.icon;

            return (
                <div className="fixed inset-0 bg-black/40 z-[100] flex items-end sm:items-center justify-center animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <div className="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-4 sm:hidden"></div>
                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-4 ${step.colorName === 'blue' ? 'bg-blue-100 text-blue-600' : step.colorName === 'indigo' ? 'bg-indigo-100 text-indigo-600' : step.colorName === 'purple' ? 'bg-purple-100 text-purple-600' : step.colorName === 'fuchsia' ? 'bg-fuchsia-100 text-fuchsia-600' : 'bg-emerald-100 text-emerald-600'}`}>
                            <StepIcon size={24} />
                        </div>
                        <h3 className="text-xl font-bold text-slate-900 mb-1">{step.title}</h3>
                        <div className="text-3xl font-bold text-slate-800 mb-4">{step.value} <span className="text-sm font-normal text-slate-400">{step.unit}</span></div>
                        
                        <div className="space-y-3 bg-slate-50 p-4 rounded-xl">
                            {step.metrics.map((m, i) => (
                                <div key={i} className="flex justify-between text-sm">
                                    <span className="text-slate-500">{m.label}</span>
                                    <span className="font-bold text-slate-800">{m.val}</span>
                                </div>
                            ))}
                        </div>
                        <button onClick={onClose} className="w-full mt-6 bg-slate-900 text-white py-3 rounded-xl font-bold active:scale-95 transition-transform">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            );
        };

        const FunnelVisualizer = ({ stats, cpc, cpl, crClickToLead, crLeadToQual, crQualToMeeting, crMeetingToDeal, avgCheck, onStepClick }) => {
            const steps = [
                {
                    id: 'traffic', title: '–¢—Ä–∞—Ñ–∏–∫', value: stats.clicksNeeded, unit: '–∫–ª–∏–∫–æ–≤', colorName: 'blue', icon: Icons.Pointer, width: '100%',
                    metrics: [{label: '–ë—é–¥–∂–µ—Ç', val: formatMoney(stats.adBudget)}, {label: '–¶–µ–Ω–∞ –∫–ª–∏–∫–∞ (CPC)', val: `${cpc} ‚ÇΩ`}, {label: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ª–∏–¥', val: `${crClickToLead}%`}]
                },
                {
                    id: 'leads', title: '–õ–∏–¥—ã', value: stats.leadsNeeded, unit: '–∑–∞—è–≤–æ–∫', colorName: 'indigo', icon: Icons.User, width: '90%',
                    metrics: [{label: 'CPL (–ö–∞–±–∏–Ω–µ—Ç)', val: `${Math.round(stats.derivedCpl)} ‚ÇΩ`}, {label: 'REAL CPL (–° —Ä–∞–±–æ—Ç–æ–π)', val: `${Math.round(stats.realCPL)} ‚ÇΩ`}]
                },
                {
                    id: 'qual', title: '–ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ', value: stats.qualLeadsNeeded, unit: '–ª–∏–¥–æ–≤', colorName: 'purple', icon: Icons.CheckSquare, width: '80%',
                    metrics: [{label: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤–æ –≤—Å—Ç—Ä–µ—á—É', val: `${crQualToMeeting}%`}]
                },
                {
                    id: 'meet', title: '–í—Å—Ç—Ä–µ—á–∏ / –ö–ü', value: stats.meetingsNeeded, unit: '–≤—Å—Ç—Ä–µ—á', colorName: 'fuchsia', icon: Icons.Briefcase, width: '70%',
                    metrics: [{label: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ —Å–¥–µ–ª–∫—É', val: `${crMeetingToDeal}%`}]
                },
                {
                    id: 'deal', title: '–ü—Ä–æ–¥–∞–∂–∏', value: stats.dealsNeeded, unit: '—Å–¥–µ–ª–æ–∫', colorName: 'emerald', icon: Icons.Banknote, width: '60%', isLast: true,
                    metrics: [{label: '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫', val: formatMoney(avgCheck)}, {label: '–í—ã—Ä—É—á–∫–∞', val: formatMoney(stats.actualRevenue)}]
                }
            ];

            return (
                <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm mb-6">
                    <div className="flex items-center gap-2 mb-6 text-slate-600">
                        <Icons.Sliders size={18} className="text-indigo-600" />
                        <span className="text-xs font-bold uppercase tracking-wider">–í–∞—à–∞ –≤–æ—Ä–æ–Ω–∫–∞ (–ù–∞–∂–º–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π)</span>
                    </div>
                    
                    <div className="flex flex-col items-center gap-1">
                        {steps.map((step, index) => (
                             <div key={step.id} className="w-full relative flex justify-center group cursor-pointer" onClick={() => onStepClick(step)}>
                                <div className={`funnel-step-shape ${step.isLast ? 'funnel-step-last' : ''} bg-${step.colorName}-600 ${step.isLast ? 'h-16' : 'h-14'} text-white flex items-center justify-center gap-6 px-4 shadow-md relative z-${50-index*10} transition-transform active:scale-95 group-hover:scale-105`} style={{ width: step.width }}>
                                    <div className="text-center">
                                        {step.id === 'traffic' ? (
                                            <>
                                                <div className="text-[9px] uppercase opacity-75 font-bold">–ë—é–¥–∂–µ—Ç</div>
                                                <div className="font-bold text-lg">{formatMoney(stats.adBudget)}</div>
                                            </>
                                        ) : (
                                            <div className="flex flex-col items-center leading-tight">
                                                <span className={`font-bold ${step.isLast ? 'text-3xl' : 'text-xl'}`}>{formatNum(step.value)}</span>
                                                <span className="text-[10px] uppercase opacity-75 font-bold tracking-wider">{step.title}</span>
                                            </div>
                                        )}
                                    </div>
                                     {step.id === 'traffic' && (
                                        <div className="text-center">
                                            <div className="text-[9px] uppercase opacity-75 font-bold">–ö–ª–∏–∫–∏</div>
                                            <div className="font-bold text-lg">{formatNum(stats.clicksNeeded)}</div>
                                        </div>
                                    )}
                                </div>
                                {!step.isLast && (
                                    <div className={`absolute -bottom-3 z-${50-index*10} bg-white rounded-full p-0.5 border border-slate-100 shadow-sm`}>
                                        <Icons.ArrowDown className="w-3 h-3 text-slate-400 arrow-bounce" />
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const RevenueBreakdown = ({ stats, isProfitable }) => {
            const revenue = stats.actualRevenue;
            if (revenue <= 0) return null;
            const pCogs = (stats.cogs / revenue) * 100;
            const pMarketing = (stats.marketingTotalCost / revenue) * 100;
            const pFixed = (stats.totalFixedPeriod / revenue) * 100;
            const pVar = (stats.totalVariableCosts / revenue) * 100;
            const totalCostsP = pCogs + pMarketing + pFixed + pVar;
            const pProfit = 100 - totalCostsP; 
            const scale = totalCostsP > 100 ? (100 / totalCostsP) : 1;

            return (
                <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mt-6">
                    <div className="flex items-center gap-2 mb-4">
                        <Icons.PieChart size={18} className="text-blue-600" />
                        <h3 className="font-bold text-slate-800 text-sm">–ö—É–¥–∞ —É—Ö–æ–¥—è—Ç –¥–µ–Ω—å–≥–∏?</h3>
                    </div>
                    <div className="h-10 w-full bg-slate-100 rounded-xl overflow-hidden flex mb-4 border border-slate-200 relative">
                        {stats.cogs > 0 && <div style={{ width: `${pCogs * scale}%` }} className="h-full bg-slate-400"></div>}
                        {stats.marketingTotalCost > 0 && <div style={{ width: `${pMarketing * scale}%` }} className="h-full bg-blue-500"></div>}
                        {stats.totalFixedPeriod > 0 && <div style={{ width: `${pFixed * scale}%` }} className="h-full bg-orange-400"></div>}
                        {stats.totalVariableCosts > 0 && <div style={{ width: `${pVar * scale}%` }} className="h-full bg-yellow-400"></div>}
                        {pProfit > 0 ? (
                            <div style={{ width: `${pProfit * scale}%` }} className="h-full bg-emerald-500"></div>
                        ) : (
                            <div className="absolute right-0 top-0 bottom-0 bg-red-500/20 flex items-center justify-center border-l-2 border-red-500" style={{left: `${100 * scale}%`}}>
                                <span className="text-[10px] font-bold text-red-700 px-1">–î–û–õ–ì</span>
                            </div>
                        )}
                    </div>
                    <div className="space-y-2 text-xs">
                        {stats.cogs > 0 && <div className="flex justify-between items-center"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-slate-400"></div>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</div><span className="font-medium text-slate-600">{formatMoney(stats.cogs)}</span></div>}
                        <div className="flex justify-between items-center"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500"></div>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ (–í—Å–µ–≥–æ)</div><span className="font-medium text-slate-600">{formatMoney(stats.marketingTotalCost)}</span></div>
                        <div className="flex justify-between items-center"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-orange-400"></div>–û—Ñ–∏—Å –∏ –ó–ü</div><span className="font-medium text-slate-600">{formatMoney(stats.totalFixedPeriod)}</span></div>
                        <div className="flex justify-between items-center"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-yellow-400"></div>–ù–∞–ª–æ–≥–∏ –∏ %</div><span className="font-medium text-slate-600">{formatMoney(stats.totalVariableCosts)}</span></div>
                        <div className={`flex justify-between items-center pt-2 mt-2 border-t border-slate-100 font-bold ${isProfitable ? 'text-emerald-700' : 'text-red-600'}`}>
                            <div className="flex items-center gap-2"><div className={`w-2 h-2 rounded-full ${isProfitable ? 'bg-emerald-500' : 'bg-red-500'}`}></div>{isProfitable ? '–û—Å—Ç–∞–µ—Ç—Å—è –≤–∞–º (–ü—Ä–∏–±—ã–ª—å)' : '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç (–£–±—ã—Ç–æ–∫)'}</div><span>{formatMoney(stats.netProfit)}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const WhatIfSection = ({ simulations }) => (
            <div className="space-y-3">
                <div className="flex items-center gap-2 mb-2 text-indigo-700">
                    <Icons.Zap size={18} />
                    <h3 className="font-bold text-sm">–ê —á—Ç–æ –µ—Å–ª–∏? (–¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞)</h3>
                </div>
                <div className="grid grid-cols-1 gap-2">
                    {simulations.map((sim) => (
                        <div key={sim.id} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className={`p-2 rounded-lg bg-${sim.color}-100 text-${sim.color}-600`}>
                                    <sim.icon size={16} />
                                </div>
                                <div>
                                    <div className="text-xs font-bold text-slate-700">{sim.title}</div>
                                    <div className="text-[10px] text-emerald-600 font-bold">
                                        {sim.diff > 0 ? '+' : ''}{formatMoney(sim.diff)} –∫ –ø—Ä–∏–±—ã–ª–∏
                                    </div>
                                </div>
                            </div>
                            <button 
                                onClick={sim.apply}
                                className={`text-xs bg-${sim.color}-50 text-${sim.color}-700 px-3 py-1.5 rounded-lg font-bold hover:bg-${sim.color}-100 transition-colors`}
                            >
                                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- MAIN APP ---

        const App = () => {
            const TELEGRAM_USERNAME = 'antongrankin'; 

            // --- STATE ---
            const [mode, setMode] = useState('pro'); 
            const [showDefinitions, setShowDefinitions] = useState(null);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [activeFunnelStep, setActiveFunnelStep] = useState(null);
            
            // 1. –¶–ï–õ–ò 
            const [targetRevenue, setTargetRevenue] = useState(1000000); 
            const [targetProfitSimple, setTargetProfitSimple] = useState(300000); 

            const [avgCheck, setAvgCheck] = useState(50000); 
            const [marginPercent, setMarginPercent] = useState(50); 
            const [period, setPeriod] = useState('month'); 

            // 2. –í–û–†–û–ù–ö–ê
            const [cpc, setCpc] = useState(25); 
            const [crClickToLead, setCrClickToLead] = useState(5); 
            const [crLeadToQual, setCrLeadToQual] = useState(60); 
            const [crQualToMeeting, setCrQualToMeeting] = useState(40); 
            const [crMeetingToDeal, setCrMeetingToDeal] = useState(30); 
            const [cpl, setCpl] = useState(1000); 
            
            // 3. –†–ê–°–•–û–î–´
            const [marketingFix, setMarketingFix] = useState(50000);
            const [variableExpenses, setVariableExpenses] = useState([
                { id: 1, name: '–ù–∞–ª–æ–≥', percent: 6 },
                { id: 2, name: '–ö–æ–º–∏—Å—Å–∏—è', percent: 0 }
            ]);
            const [fixedExpenses, setFixedExpenses] = useState([
                { id: 1, name: '–§–û–¢ (–ó–∞—Ä–ø–ª–∞—Ç—ã)', amount: 50000 },
                { id: 2, name: '–û—Ñ–∏—Å / –°–µ—Ä–≤–∏—Å—ã', amount: 30000 },
                { id: 3, name: '–ü—Ä–æ—á–µ–µ', amount: 5000 }
            ]);

            const [scaleBudget, setScaleBudget] = useState(0);
            const [activeBenchmark, setActiveBenchmark] = useState(null);

            // --- ACTIONS ---
            const toggleMode = (newMode) => setMode(newMode);

            const addVariableExpense = () => setVariableExpenses([...variableExpenses, { id: Date.now(), name: '', percent: 0 }]);
            const removeVariableExpense = (id) => setVariableExpenses(variableExpenses.filter(e => e.id !== id));
            const updateVariableExpense = (id, field, value) => setVariableExpenses(variableExpenses.map(e => e.id === id ? { ...e, [field]: value } : e));

            const addFixedExpense = () => setFixedExpenses([...fixedExpenses, { id: Date.now(), name: '', amount: 0 }]);
            const removeFixedExpense = (id) => setFixedExpenses(fixedExpenses.filter(e => e.id !== id));
            const updateFixedExpense = (id, field, value) => setFixedExpenses(fixedExpenses.map(e => e.id === id ? { ...e, [field]: value } : e));
            
            const applyBenchmark = (type) => {
                const b = BENCHMARKS[type];
                setCrLeadToQual(b.cr1); setCrQualToMeeting(b.cr2); setCrMeetingToDeal(b.cr3); setCpl(b.cpl);
                if(b.cpc) setCpc(b.cpc);
                if(b.crClick) setCrClickToLead(b.crClick);
                setActiveBenchmark(type);
            };

            const resetAll = () => {
                setTargetRevenue(1000000); setTargetProfitSimple(300000); setAvgCheck(50000); setMarginPercent(50);
                setCrLeadToQual(60); setCrQualToMeeting(40); setCrMeetingToDeal(30); setCpl(1000);
                setCpc(25); setCrClickToLead(5);
                setMarketingFix(50000);
                setVariableExpenses([{ id: 1, name: '–ù–∞–ª–æ–≥', percent: 6 }, { id: 2, name: '–ö–æ–º–∏—Å—Å–∏—è', percent: 0 }]);
                setFixedExpenses([{ id: 1, name: '–§–û–¢ (–ó–∞—Ä–ø–ª–∞—Ç—ã)', amount: 50000 }, { id: 2, name: '–û—Ñ–∏—Å / –°–µ—Ä–≤–∏—Å—ã', amount: 30000 }, { id: 3, name: '–ü—Ä–æ—á–µ–µ', amount: 5000 }]);
                setScaleBudget(0); setActiveBenchmark(null);
            };

            // --- CALCULATIONS CORE ---
            const calculateEconomics = (overrides = {}) => {
                let pm = 1;
                if (period === 'quarter') pm = 3;
                if (period === 'year') pm = 12;

                let _targetRevenue = overrides.targetRevenue ?? targetRevenue;
                if (mode === 'simple' && !overrides.targetRevenue) {
                    _targetRevenue = targetProfitSimple / (marginPercent / 100);
                    if (marginPercent > 20) _targetRevenue = targetProfitSimple / ((marginPercent - 15) / 100);
                    if (_targetRevenue < 0 || !isFinite(_targetRevenue)) _targetRevenue = 0;
                }

                const totalRevenueTarget = _targetRevenue * pm;

                const _avgCheck = overrides.avgCheck ?? avgCheck;
                const _marginPercent = overrides.marginPercent ?? marginPercent;
                const _cpl = overrides.cpl ?? cpl;
                const _cpc = overrides.cpc ?? cpc;

                const _crLeadToQual = overrides.crLeadToQual ?? crLeadToQual;
                const _crQualToMeeting = overrides.crQualToMeeting ?? crQualToMeeting;
                const _crMeetingToDeal = overrides.crMeetingToDeal ?? crMeetingToDeal;
                const _crClickToLead = overrides.crClickToLead ?? crClickToLead;

                // 1. Sales
                const dealsNeeded = Math.ceil(totalRevenueTarget / _avgCheck);
                const actualRevenue = dealsNeeded * _avgCheck;
                const grossMarginRub = actualRevenue * (_marginPercent / 100);
                const cogs = actualRevenue - grossMarginRub; 

                // 2. Funnel
                const safeCrMeeting = _crMeetingToDeal > 0 ? _crMeetingToDeal : 1;
                const safeCrQual = _crQualToMeeting > 0 ? _crQualToMeeting : 1;
                const safeCrLead = _crLeadToQual > 0 ? _crLeadToQual : 1;

                const meetingsNeeded = Math.ceil(dealsNeeded / (safeCrMeeting / 100));
                const qualLeadsNeeded = Math.ceil(meetingsNeeded / (safeCrQual / 100));
                const leadsNeeded = Math.ceil(qualLeadsNeeded / (safeCrLead / 100));
                
                const clicksNeeded = Math.ceil(leadsNeeded / (_crClickToLead > 0 ? _crClickToLead/100 : 0.01));

                // 3. Budget (Platform Spend)
                let adBudget = leadsNeeded * _cpl;
                if (mode === 'pro') adBudget = clicksNeeded * _cpc;

                // 4. Marketing TOTAL Cost (Budget + Fix)
                const marketingLaborCost = marketingFix * pm;
                const marketingTotalCost = adBudget + marketingLaborCost;
                const realCPL = leadsNeeded > 0 ? marketingTotalCost / leadsNeeded : 0;

                // 5. Expenses
                const totalFixedMonthly = fixedExpenses.reduce((sum, item) => sum + item.amount, 0);
                const totalFixedPeriod = totalFixedMonthly * pm;

                const totalVariablePercent = variableExpenses.reduce((sum, item) => sum + item.percent, 0);
                const totalVariableCosts = actualRevenue * (totalVariablePercent / 100);
                
                // Total Expenses = MarketingTotal + Fixed + Variable
                const totalExpenses = marketingTotalCost + totalFixedPeriod + totalVariableCosts;

                // 6. Results
                const correctNetProfit = grossMarginRub - (marketingTotalCost + totalFixedPeriod + totalVariableCosts);
                
                // Profit Before Marketing
                const profitBeforeMarketing = grossMarginRub - totalFixedPeriod - totalVariableCosts;
                
                let marketingShareOfProfit = 0;
                let mtpStatus = 'normal'; 

                if (profitBeforeMarketing > 0) {
                     marketingShareOfProfit = (marketingTotalCost / profitBeforeMarketing) * 100;
                     if (marketingShareOfProfit > 100) mtpStatus = 'critical'; 
                } else {
                     mtpStatus = 'no_profit'; 
                }

                // DRR Metrics
                const drrRevenue = actualRevenue > 0 ? (adBudget / actualRevenue) * 100 : 0; // Just Platform budget
                const drrTotalRevenue = actualRevenue > 0 ? (marketingTotalCost / actualRevenue) * 100 : 0; // Total Marketing
                
                // Helper to get DRR status
                const getDrrStatus = (val) => {
                    if (val < 5) return { 
                        style: 'bg-emerald-500/20 text-emerald-100 border-emerald-500/50', 
                        label: '–°–£–ü–ï–†', 
                        icon: <Icons.CheckCircle2 size={14} /> 
                    };
                    if (val < 10) return { 
                        style: 'bg-yellow-500/20 text-yellow-100 border-yellow-500/50', 
                        label: '–ù–û–†–ú–ê', 
                        icon: <Icons.Info size={14} /> 
                    };
                    if (val < 15) return { 
                        style: 'bg-orange-500/20 text-orange-100 border-orange-500/50', 
                        label: '–†–ò–°–ö', 
                        icon: <Icons.AlertTriangle size={14} /> 
                    };
                    return { 
                        style: 'bg-red-500/20 text-red-100 border-red-500/50', 
                        label: '–£–ë–´–¢–ö–ò', 
                        icon: <Icons.XCircle size={14} /> 
                    };
                };
                
                // Color for DRR (legacy)
                const getDrrColor = (val) => {
                    if (val < 5) return 'text-emerald-600 bg-emerald-50 border-emerald-100';
                    if (val < 10) return 'text-yellow-600 bg-yellow-50 border-yellow-100';
                    if (val < 15) return 'text-orange-600 bg-orange-50 border-orange-100';
                    return 'text-red-600 bg-red-50 border-red-100';
                };

                return {
                    dealsNeeded, actualRevenue, cogs, grossMarginRub,
                    clicksNeeded, leadsNeeded, qualLeadsNeeded, meetingsNeeded,
                    adBudget, marketingTotalCost, totalExpenses, netProfit: correctNetProfit, 
                    drrRevenue, drrTotalRevenue, marketingShareOfProfit, mtpStatus,
                    totalFixedPeriod, totalVariableCosts,
                    derivedCpl: mode === 'pro' && leadsNeeded > 0 ? adBudget / leadsNeeded : _cpl,
                    realCPL,
                    getDrrColor,
                    getDrrStatus,
                    profitBeforeMarketing
                };
            };

            const stats = calculateEconomics();
            const isProfitable = stats.netProfit > 0;

            useEffect(() => { 
                if (scaleBudget === 0 && stats.adBudget > 0) setScaleBudget(stats.adBudget); 
            }, [stats.adBudget]);

            const scaleStats = useMemo(() => {
                const scaledLeads = Math.ceil(scaleBudget / (mode === 'pro' ? (cpc * (100/crClickToLead)) : cpl));
                const scaledDeals = Math.ceil(scaledLeads * (crLeadToQual/100) * (crQualToMeeting/100) * (crMeetingToDeal/100));
                const scaledRevenue = scaledDeals * avgCheck;
                const scaledCogs = scaledRevenue * ((100 - marginPercent) / 100);
                const scaledVarCosts = scaledRevenue * (variableExpenses.reduce((s, e) => s + e.percent, 0) / 100);
                const pm = period === 'month' ? 1 : period === 'quarter' ? 3 : 12;
                const fixedCosts = fixedExpenses.reduce((s, e) => s + e.amount, 0) * pm;
                const scaledMarketingTotal = scaleBudget + (marketingFix * pm);
                const scaledProfit = scaledRevenue - scaledCogs - scaledVarCosts - fixedCosts - scaledMarketingTotal;
                return { revenue: scaledRevenue, profit: scaledProfit };
            }, [scaleBudget, mode, cpc, crClickToLead, cpl, crLeadToQual, crQualToMeeting, crMeetingToDeal, avgCheck, marginPercent, variableExpenses, period, fixedExpenses, marketingFix]);

            const simulations = [
                { id: 'sales_up', title: '–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø—Ä–æ–¥–∞–∂—É +5%', icon: Icons.TrendingUp, color: 'emerald', apply: () => setCrMeetingToDeal(prev => Math.min(prev + 5, 100)), diff: calculateEconomics({ crMeetingToDeal: Math.min(crMeetingToDeal + 5, 100) }).netProfit - stats.netProfit },
                { id: 'cpl_down', title: '–°–Ω–∏–∑–∏—Ç—å CPL –Ω–∞ 20%', icon: Icons.Send, color: 'blue', apply: () => setCpl(prev => Math.floor(prev * 0.8)), diff: calculateEconomics({ cpl: cpl * 0.8 }).netProfit - stats.netProfit },
                { id: 'check_up', title: '–ü–æ–¥–Ω—è—Ç—å —á–µ–∫ –Ω–∞ 10%', icon: Icons.Plus, color: 'purple', apply: () => setAvgCheck(prev => Math.floor(prev * 1.1)), diff: calculateEconomics({ avgCheck: avgCheck * 1.1 }).netProfit - stats.netProfit }
            ];

            const generateTelegramLink = () => {
                const text = `
üöÄ –†–∞—Å—á–µ—Ç Unit Economics

üí∞ *–¶–µ–ª—å:* ${formatNum(stats.actualRevenue)} ‚ÇΩ (${period})
üí∏ *–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥:* ${formatMoney(stats.marketingTotalCost)}
üìâ *–î–†–† (Total):* ${stats.drrTotalRevenue.toFixed(1)}%

üèÜ *–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:* ${formatMoney(stats.netProfit)}
                `.trim();
                return `https://t.me/${TELEGRAM_USERNAME}?text=${encodeURIComponent(text)}`;
            };
            
            const drrStatus = stats.getDrrStatus(stats.drrRevenue);
            const totalDrrStatus = stats.getDrrStatus(stats.drrTotalRevenue);

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-800 pb-32 md:pb-0">
                    {showDefinitions && <DefinitionModal term={showDefinitions} onClose={() => setShowDefinitions(null)} />}
                    {activeFunnelStep && <FunnelDetailModal step={activeFunnelStep} onClose={() => setActiveFunnelStep(null)} />}

                    <header className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm"><div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between"><div className="flex items-center gap-3"><div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md"><Icons.Calculator size={16} /></div><div className="leading-none"><h1 className="text-base font-bold text-slate-900">Unit Profit</h1><span className="text-[10px] text-slate-500 font-medium">–°–∏–º—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏ v10.4 Final</span></div></div><div className="flex items-center gap-3"><div className="flex bg-slate-100 rounded-lg p-1"><button onClick={() => setMode('simple')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${mode === 'simple' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>–ù–æ–≤–∏—á–æ–∫</button><button onClick={() => setMode('pro')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${mode === 'pro' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>PRO</button></div><button onClick={resetAll} className="p-2 text-slate-400 hover:text-slate-600"><Icons.RefreshCw size={18} /></button></div></div></header>
                    <main className="max-w-6xl mx-auto px-2 sm:px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-7 space-y-4">
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 card-shadow">
                                <div className="flex items-center gap-2 mb-4 pb-2 border-b border-slate-100"><Icons.Target size={18} className="text-indigo-600" /><h2 className="font-bold text-slate-800">1. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏</h2></div>
                                {mode === 'simple' ? (
                                    <div className="space-y-4">
                                        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-center">
                                            <div className="text-xs text-indigo-500 font-bold uppercase mb-1">–Ø —Ö–æ—á—É –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å (–ß–∏—Å—Ç—ã–º–∏)</div>
                                            <div className="relative flex justify-center">
                                                <input type="text" value={formatNum(targetProfitSimple)} onChange={(e) => { const val = Number(e.target.value.replace(/[^0-9]/g, '')); setTargetProfitSimple(val); }} className="w-full bg-transparent text-center text-3xl font-bold text-indigo-900 outline-none" />
                                                <span className="absolute right-4 top-2 text-indigo-300">‚ÇΩ</span>
                                            </div>
                                            <input type="range" min="0" max="3000000" step="10000" value={targetProfitSimple} onChange={(e) => setTargetProfitSimple(Number(e.target.value))} className="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 mt-2" />
                                            <div className="text-xs text-indigo-400 mt-1">–≤ –º–µ—Å—è—Ü</div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <FormattedInput label="–°—Ä–µ–¥–Ω–∏–π —á–µ–∫" value={avgCheck} onChange={setAvgCheck} suffix="‚ÇΩ" />
                                            <FormattedInput label="–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å" value={marginPercent} onChange={setMarginPercent} suffix="%" />
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex bg-slate-100 p-1 rounded-xl mb-5">
                                            {['month', 'quarter', 'year'].map(p => (
                                                <button key={p} onClick={() => setPeriod(p)} className={`flex-1 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${period === p ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                                    {p === 'month' ? '–ú–µ—Å—è—Ü' : p === 'quarter' ? '–ö–≤–∞—Ä—Ç–∞–ª' : '–ì–æ–¥'}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div className="sm:col-span-2">
                                                <FormattedInput label="–ñ–µ–ª–∞–µ–º–∞—è –≤—ã—Ä—É—á–∫–∞ (–û–±–æ—Ä–æ—Ç)" value={targetRevenue} onChange={setTargetRevenue} suffix="‚ÇΩ" />
                                                <input 
                                                    type="range" 
                                                    min="100000" 
                                                    max="10000000" 
                                                    step="100000" 
                                                    value={Math.min(targetRevenue, 10000000)}
                                                    onChange={(e) => setTargetRevenue(Number(e.target.value))} 
                                                    className="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 -mt-2" 
                                                />
                                                <div className="flex justify-between text-[10px] text-slate-400 mt-1 px-1">
                                                    <span>100 —Ç—ã—Å</span>
                                                    <span>10 –º–ª–Ω</span>
                                                </div>
                                            </div>
                                            <FormattedInput label="–°—Ä–µ–¥–Ω–∏–π —á–µ–∫" value={avgCheck} onChange={setAvgCheck} suffix="‚ÇΩ" />
                                            <FormattedInput label="–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å" value={marginPercent} onChange={setMarginPercent} suffix="%" />
                                        </div>
                                    </>
                                )}
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 card-shadow">
                                <div className="flex items-center gap-2 mb-4 pb-2 border-b border-slate-100"><Icons.Sliders size={18} className="text-blue-600" /><h2 className="font-bold text-slate-800">2. –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h2></div>
                                <div className="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 relative overflow-hidden"><div className="relative z-10"><div className="flex gap-2 items-start mb-3"><Icons.Info className="w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0" /><h3 className="font-bold text-blue-900 text-sm">–ù–µ –∑–Ω–∞–µ—Ç–µ —Å–≤–æ–∏ —Ü–∏—Ñ—Ä—ã?</h3></div><div className="grid grid-cols-3 gap-2">{Object.entries(BENCHMARKS).map(([key, val]) => (<button key={key} onClick={() => applyBenchmark(key)} className={`flex flex-col items-center justify-center p-2 rounded-lg border text-center transition-all ${activeBenchmark === key ? 'bg-white border-blue-500 shadow-md ring-1 ring-blue-500' : 'bg-white/60 border-blue-200 hover:bg-white'}`}><span className={`mb-1 ${activeBenchmark === key ? 'text-blue-600' : 'text-slate-400'}`}>{key === 'services' && <Icons.Briefcase size={16} />}{key === 'ecommerce' && <Icons.ShoppingBag size={16} />}{key === 'infobiz' && <Icons.GraduationCap size={16} />}</span><span className={`text-[10px] font-bold leading-tight ${activeBenchmark === key ? 'text-blue-800' : 'text-slate-500'}`}>{val.name}</span></button>))}</div></div></div>
                                <div className="space-y-4">
                                    {mode === 'pro' && (
                                        <div className="grid grid-cols-1 gap-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <FormattedInput label="CPC (–¶–µ–Ω–∞ –∫–ª–∏–∫–∞)" value={cpc} onChange={setCpc} suffix="‚ÇΩ" />
                                                <FormattedInput label="CR –ö–ª–∏–∫ -> –õ–∏–¥ (%)" value={crClickToLead} onChange={setCrClickToLead} suffix="%" />
                                            </div>
                                            <FormattedInput label="–õ–∏–¥ ‚Üí –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π (%)" value={crLeadToQual} onChange={setCrLeadToQual} suffix="%" />
                                            <FormattedInput label="–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π ‚Üí –í—Å—Ç—Ä–µ—á–∞ (%)" value={crQualToMeeting} onChange={setCrQualToMeeting} suffix="%" />
                                            <FormattedInput label="–í—Å—Ç—Ä–µ—á–∞ ‚Üí –°–¥–µ–ª–∫–∞ (%)" value={crMeetingToDeal} onChange={setCrMeetingToDeal} suffix="%" />
                                        </div>
                                    )}
                                    <div className="pt-4 border-t border-slate-100">
                                        <div className="flex items-center gap-2 mb-1.5">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">–¶–µ–Ω–∞ –∑–∞—è–≤–∫–∏ (CPL)</label>
                                            <button onClick={() => setShowDefinitions('CPL')} className="text-indigo-400 hover:text-indigo-600">
                                                <Icons.HelpCircle size={14} />
                                            </button>
                                        </div>
                                        <FormattedInput label="" value={cpl} onChange={setCpl} suffix="‚ÇΩ" />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 card-shadow">
                                <div className="flex items-center gap-2 mb-4 pb-2 border-b border-slate-100"><Icons.Banknote size={18} className="text-emerald-600" /><h2 className="font-bold text-slate-800">3. –†–∞—Å—Ö–æ–¥—ã</h2></div>
                                
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6">
                                    <div className="text-xs font-bold text-indigo-800 mb-2 uppercase tracking-wider">–ó–ü –ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞ (–§–∏–∫—Å)</div>
                                    <FormattedInput label="" value={marketingFix} onChange={setMarketingFix} suffix="‚ÇΩ" />
                                    <div className="text-[10px] text-indigo-600 opacity-80">–ó–∞—Ä–ø–ª–∞—Ç—ã —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤, –∞–≥–µ–Ω—Ç—Å—Ç–≤ –∏ —Ç.–¥. –í–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π CPL.</div>
                                </div>

                                <div className="mb-6">
                                    <div className="flex justify-between items-center mb-3">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (% –æ—Ç –≤—ã—Ä—É—á–∫–∏)</label>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {variableExpenses.map((expense) => (
                                            <div key={expense.id} className="bg-slate-50 p-2 rounded-xl border border-slate-100 flex items-center justify-between">
                                                <span className="text-sm font-bold text-slate-700 ml-1">{expense.name}</span>
                                                <div className="relative w-16">
                                                    <input type="number" value={expense.percent} placeholder="0" onChange={(e) => updateVariableExpense(expense.id, 'percent', Number(e.target.value))} className="w-full bg-white border border-slate-200 rounded-lg px-1 py-1 text-sm text-right focus:ring-1 focus:ring-indigo-500 outline-none" />
                                                    <span className="absolute right-4 top-1 text-slate-400 text-xs">%</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-3">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ (–º–µ—Å)</label>
                                        <button onClick={addFixedExpense} className="text-indigo-600 hover:bg-indigo-50 p-1 rounded transition-colors">
                                            <Icons.Plus size={16} />
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {fixedExpenses.map((expense) => (
                                            <div key={expense.id} className="bg-slate-50 p-3 rounded-xl border border-slate-100 flex gap-2 items-center">
                                                <input type="text" value={expense.name} placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" onChange={(e) => updateFixedExpense(expense.id, 'name', e.target.value)} className="flex-1 bg-transparent border-none p-0 text-sm font-bold text-slate-700 focus:ring-0 placeholder:text-slate-300" />
                                                <div className="relative w-32">
                                                    <TableInput value={expense.amount} placeholder="0" align="right" onChange={(val) => updateFixedExpense(expense.id, 'amount', val)} />
                                                    <span className="absolute right-6 top-1.5 text-slate-400 text-xs">‚ÇΩ</span>
                                                </div>
                                                <button onClick={() => removeFixedExpense(expense.id)} className="text-slate-300 hover:text-red-500 p-1">
                                                    <Icons.Trash2 size={16} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-5">
                            {/* Results Column */}
                            <div className="pb-32 lg:pb-0">
                                <div className={`rounded-3xl p-6 shadow-xl text-white transition-all duration-500 relative overflow-hidden ${isProfitable ? 'bg-slate-900' : 'bg-red-600'}`}>
                                    <div className="absolute -right-10 -top-10 w-40 h-40 bg-white opacity-5 rounded-full blur-3xl"></div>
                                    <div className="relative z-10">
                                        <div className="text-xs font-bold text-white/70 mb-2 leading-relaxed">
                                            –ß—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å <span className="text-white border-b border-white/30">{formatMoney(mode === 'simple' ? targetProfitSimple : targetRevenue * (period === 'month'?1: period==='quarter'?3:12))}</span> {mode === 'simple' ? '—á–∏—Å—Ç—ã–º–∏' : ''}, –Ω—É–∂–Ω–æ –ø—Ä–∏–≤–ª–µ—á—å <span className="text-white border-b border-white/30">{formatNum(stats.leadsNeeded)} –∑–∞—è–≤–æ–∫</span>.
                                        </div>
                                        <div className="flex justify-between items-start mb-1 mt-4">
                                            <div className="flex items-center gap-2 text-xs font-bold uppercase tracking-wider opacity-80">
                                                {isProfitable ? <Icons.CheckCircle2 size={14}/> : <Icons.XCircle size={14}/>} –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å
                                            </div>
                                        </div>
                                        <div className="text-4xl font-bold mb-1 tracking-tight">{formatMoney(stats.netProfit)}</div>
                                        
                                        <div className="mt-4 space-y-2">
                                            <div className={`p-2 rounded-lg flex justify-between items-center text-xs font-bold border ${drrStatus.style} cursor-pointer hover:bg-white/10 transition-colors`} onClick={() => setShowDefinitions('DRR')}>
                                                <div className="flex items-center gap-2 term-link">
                                                    {drrStatus.icon}
                                                    <span>–î–†–† (–†–µ–∫–ª–∞–º–∞):</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span>{stats.drrRevenue.toFixed(1)}%</span>
                                                    <span className="text-[10px] opacity-80 font-normal uppercase tracking-wider border px-1 rounded">{drrStatus.label}</span>
                                                </div>
                                            </div>
                                            <div className={`p-2 rounded-lg flex justify-between items-center text-xs font-bold border ${totalDrrStatus.style} cursor-pointer hover:bg-white/10 transition-colors`} onClick={() => setShowDefinitions('TotalDRR')}>
                                                <div className="flex items-center gap-2 term-link">
                                                    {totalDrrStatus.icon}
                                                    <span>–î–†–† (–ò—Ç–æ–≥–æ–≤—ã–π):</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span>{stats.drrTotalRevenue.toFixed(1)}%</span>
                                                    <span className="text-[10px] opacity-80 font-normal uppercase tracking-wider border px-1 rounded">{totalDrrStatus.label}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="mt-4 pt-4 border-t border-white/10">
                                            <div className="text-xs font-bold text-white/80 uppercase tracking-wider mb-2">–í—Å—è –ø—Ä–∞–≤–¥–∞ –æ –ø—Ä–∏–±—ã–ª–∏</div>
                                            <div className="bg-white/10 p-2 rounded-lg text-xs flex justify-between items-center cursor-pointer hover:bg-white/20 mb-2" onClick={() => setShowDefinitions('PBM')}>
                                                <span className="opacity-70 term-link">–ü—Ä–∏–±—ã–ª—å –î–û –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞:</span>
                                                <span className="font-bold text-white">{formatMoney(stats.profitBeforeMarketing)}</span>
                                            </div>
                                            <div className="bg-white/10 p-2 rounded-lg text-xs flex justify-between items-center cursor-pointer hover:bg-white/20 mb-3" onClick={() => setShowDefinitions('MTP')}>
                                                <span className="opacity-70 term-link">–î–æ–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –≤ –ø—Ä–∏–±—ã–ª–∏:</span>
                                                <span className={`font-bold ${stats.mtpStatus === 'critical' || stats.mtpStatus === 'no_profit' ? 'text-red-300' : 'text-emerald-300'}`}>
                                                    {stats.mtpStatus === 'no_profit' ? '–ü—Ä–∏–±—ã–ª–∏ –Ω–µ—Ç' : stats.mtpStatus === 'critical' ? '–°—ä–µ–¥–∞–µ—Ç –≤—Å—é –ø—Ä–∏–±—ã–ª—å' : `${stats.marketingShareOfProfit.toFixed(0)}%`}
                                                </span>
                                            </div>

                                            <div className="text-xs font-bold text-white/80 uppercase tracking-wider mb-2 mt-4">–ß–µ—Å—Ç–Ω—ã–π –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                                            <div className="grid grid-cols-2 gap-4 text-xs mb-3">
                                                <div className="cursor-pointer hover:bg-white/5 rounded p-1" onClick={() => setShowDefinitions('CPL')}>
                                                    <div className="opacity-50 mb-0.5 flex items-center gap-1 term-link">–¶–µ–Ω–∞ –≤ –æ—Ç—á–µ—Ç–µ <Icons.HelpCircle size={8}/></div>
                                                    <div className="font-bold text-white text-lg">{Math.round(stats.derivedCpl)} ‚ÇΩ</div>
                                                </div>
                                                <div className="cursor-pointer hover:bg-white/5 rounded p-1" onClick={() => setShowDefinitions('RealCPL')}>
                                                    <div className="opacity-50 mb-0.5 flex items-center gap-1 term-link">–¶–µ–Ω–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ <Icons.HelpCircle size={8}/></div>
                                                    <div className="font-bold text-white text-lg">{Math.round(stats.realCPL)} ‚ÇΩ</div>
                                                </div>
                                            </div>
                                        </div>
                                        <ExpertInsight stats={stats} isProfitable={isProfitable} onShowDefinition={setShowDefinitions} />
                                    </div>
                                </div>

                                <ScalingSimulator stats={stats} scaleBudget={scaleBudget} setScaleBudget={setScaleBudget} scaleStats={scaleStats} />
                                <WhatIfSection simulations={simulations} />
                                <RevenueBreakdown stats={stats} isProfitable={isProfitable} />
                                <FunnelVisualizer stats={stats} cpc={cpc} cpl={cpl} crClickToLead={crClickToLead} crLeadToQual={crLeadToQual} crQualToMeeting={crQualToMeeting} crMeetingToDeal={crMeetingToDeal} avgCheck={avgCheck} onStepClick={setActiveFunnelStep} />
                                
                                <a href={generateTelegramLink()} target="_blank" rel="noopener noreferrer" className="block w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 flex items-center justify-center gap-2 group mt-6">
                                    <Icons.Send size={18} className="group-hover:-translate-y-1 group-hover:translate-x-1 transition-transform" />
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç —ç–∫—Å–ø–µ—Ä—Ç—É
                                </a>
                            </div>
                        </div>
                    </main>

                    <div className={`lg:hidden fixed bottom-0 left-0 right-0 bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.15)] z-50 transition-all duration-300 rounded-t-2xl ${isMobileMenuOpen ? 'h-[80vh]' : 'h-auto'}`}>
                        <div className="flex justify-center pt-2 pb-1 cursor-pointer" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>
                            <div className="w-12 h-1.5 bg-slate-200 rounded-full"></div>
                        </div>
                        <div className="px-4 pb-4 pt-2 border-b border-slate-100 safe-area-bottom">
                            <div className="flex justify-between items-center">
                                <div onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="cursor-pointer">
                                    <div className="text-[10px] text-slate-500 uppercase font-bold flex items-center gap-1">–ü—Ä–∏–±—ã–ª—å {isMobileMenuOpen ? <Icons.ChevronDown size={14}/> : <Icons.ChevronUp size={14}/>}</div>
                                    <div className={`text-xl font-bold leading-none ${isProfitable ? 'text-slate-900' : 'text-red-600'}`}>{formatMoney(stats.netProfit)}</div>
                                </div>
                                <a href={generateTelegramLink()} target="_blank" rel="noopener noreferrer" className="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-md flex items-center gap-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å <Icons.Send size={14}/></a>
                            </div>
                        </div>
                        {isMobileMenuOpen && (
                            <div className="overflow-y-auto h-full px-4 pb-20 pt-4 space-y-6">
                                <ScalingSimulator stats={stats} scaleBudget={scaleBudget} setScaleBudget={setScaleBudget} scaleStats={scaleStats} />
                                <WhatIfSection simulations={simulations} />
                                <RevenueBreakdown stats={stats} isProfitable={isProfitable} />
                                <FunnelVisualizer stats={stats} cpc={cpc} cpl={cpl} crClickToLead={crClickToLead} crLeadToQual={crLeadToQual} crQualToMeeting={crQualToMeeting} crMeetingToDeal={crMeetingToDeal} avgCheck={avgCheck} onStepClick={setActiveFunnelStep} />
                                <div className="h-10"></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
